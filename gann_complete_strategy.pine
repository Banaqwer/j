// ============================================================================
// GANN COMPLETE UNIFIED STRATEGY — TradingView Pine Script v5
// ============================================================================
// Full translation of gann_trading_algorithm.py (all 21 components) into a
// live TradingView strategy for any market (BTC, ETH, Gold, Forex, Stocks).
//
// Based on W.D. Gann's methods decoded from 21 PDF documents:
//   PDFs 1-7: Core Gann methods (angles, SQ9, vibration, cycles)
//   PDFs 8-11: 144 Square, Hexagon, Price-Time Vector, Master Formula
//   PDFs 12-14: Range divisions, Master Time Factor, George Bayer
//   PDFs 15-17: Moon Beam, Jenkins, 1953 Mathematical Formula
//   PDFs 18-21: Shephard Course, Astro-Cycles, Basis of Forecasting, Law of Vibration
//
// 21 Components Implemented:
//   C1:  Gann Angle Support/Resistance (11 angles)
//   C2:  Square of 9 Price Levels
//   C3:  Number Vibration Analysis (digit reduction)
//   C4:  Daily Volatility Calculation
//   C5:  Dynamic Gann Levels (volatility-adjusted SQ9/SQ12)
//   C6:  144-Cycle Price Zones
//   C7:  Trend Confirmation from Gann Angles
//   C8:  Price-Time Squaring
//   C9:  Hexagon Chart Levels (60° angles)
//   C10: Range Percentage Divisions (1/8th & 1/3rd)
//   C11: Swing Chart Trend Analysis (HH/HL/LH/LL)
//   C12: Master 144 Square / Great Cycle (20,736)
//   C13: Seasonal Cardinal Timing (equinox/solstice)
//   C14: Fatal Number Analysis (49 and multiples)
//   C15: Shephard Key Cycles (631/668/840/1260/1290/1336)
//   C16: Planetary Cycle Windows (Mars 687d, Venus 224d)
//   C17: Cumulative Range Analysis
//   C18: Master Time Factor (7/10/20/30/60-year)
//   C19: Range Extension Levels
//   C20: Multi-Timeframe Confluence
//   C21: Confidence Scoring & Signal Generation
//
// HOW TO USE:
//   1. Open TradingView → Pine Editor
//   2. Paste this entire script
//   3. Click "Add to Chart"
//   4. Select any asset on daily timeframe
//   5. Open Strategy Tester tab to see backtest results
//   6. For demo trading: Enable "Paper Trading" in TradingView
// ============================================================================

//@version=5
strategy("Gann Complete Strategy (21 Components)", overlay=true,
     default_qty_type=strategy.percent_of_equity, default_qty_value=100,
     initial_capital=10000, commission_type=strategy.commission.percent,
     commission_value=0.1, slippage=2, pyramiding=0)

// ============================================================================
// INPUTS
// ============================================================================
grp_main     = "Main Settings"
i_riskPct    = input.float(1.5,   "Risk Per Trade (%)",       minval=0.1, maxval=10.0, step=0.1, group=grp_main)
i_rrRatio    = input.float(2.5,   "Reward:Risk Ratio",        minval=1.0, maxval=10.0, step=0.5, group=grp_main)
i_confMin    = input.float(0.40,  "Min Confidence to Trade",  minval=0.1, maxval=1.0,  step=0.05, group=grp_main)
i_volLen     = input.int(20,      "Volatility Lookback",       minval=5,   maxval=100,  group=grp_main)
i_swingLen   = input.int(50,      "Swing High/Low Lookback",   minval=10,  maxval=200,  group=grp_main)

grp_gann     = "Gann Settings"
i_showAngles = input.bool(true,   "Show Gann Angle Levels",    group=grp_gann)
i_showSQ9    = input.bool(true,   "Show Square of 9 Levels",   group=grp_gann)
i_show144    = input.bool(false,  "Show 144-Cycle Levels",     group=grp_gann)
i_showRange  = input.bool(true,   "Show Range % Levels",       group=grp_gann)
i_showHex    = input.bool(false,  "Show Hexagon Levels",       group=grp_gann)
i_sq9Tol     = input.float(0.5,   "SQ9 Confluence (%)",       minval=0.1, maxval=2.0, step=0.1, group=grp_gann)
i_dynVolThresh = input.float(40.0,"Dynamic SQ12 Trigger (Ann.Vol%)", minval=10.0, maxval=100.0, step=5.0, group=grp_gann)

grp_trade    = "Trade Management"
i_partialPct = input.float(50.0,  "Partial Exit (%)",         minval=0.0, maxval=100.0, step=10.0, group=grp_trade)
i_trailPct   = input.float(2.0,   "Trailing Stop (%)",        minval=0.5, maxval=10.0,  step=0.5, group=grp_trade)
i_maxBars    = input.int(60,      "Max Bars in Trade",         minval=10,  maxval=200,  group=grp_trade)

grp_adv      = "Advanced — New Components"
i_useFatal   = input.bool(true,   "Use Fatal Number (49)",     group=grp_adv)
i_useSwing   = input.bool(true,   "Use Swing Trend Analysis",  group=grp_adv)
i_useSeasonal= input.bool(true,   "Use Seasonal Cardinal",     group=grp_adv)
i_useRangePct= input.bool(true,   "Use Range % Confidence",    group=grp_adv)
i_useHexConf = input.bool(true,   "Use Hexagon Confidence",    group=grp_adv)
i_swingTrendLen = input.int(5,    "Swing Trend Bars",          minval=3, maxval=20, group=grp_adv)

// ============================================================================
// C1: GANN ANGLE SUPPORT/RESISTANCE (11 angles)
// ============================================================================
// Formula: level = (sqrt(base) ± degree_factor)²
// Degree factors: [0.125, 0.25, 0.333, 0.5, 1.0, 2.0, 3.0, 4.0, 8.0, 12.0, 16.0]
// Source: PDF 5 "Intraday Trade Using Gann Angle"

gannAngleLevel(float base, float degFactor, bool isUp) =>
    sq = math.sqrt(base)
    adjusted = isUp ? sq + degFactor : sq - degFactor
    adjusted > 0 ? adjusted * adjusted : na

swingHi = ta.highest(high, i_swingLen)
swingLo = ta.lowest(low,   i_swingLen)

// Resistance levels (from swing low, going up)
r_1x16  = gannAngleLevel(swingLo, 0.125, true)
r_1x8   = gannAngleLevel(swingLo, 0.25,  true)
r_1x6   = gannAngleLevel(swingLo, 0.333, true)
r_1x4   = gannAngleLevel(swingLo, 0.5,   true)   // Buy entry
r_1x1   = gannAngleLevel(swingLo, 1.0,   true)   // Key 45° angle
r_4x1   = gannAngleLevel(swingLo, 2.0,   true)
r_6x1   = gannAngleLevel(swingLo, 3.0,   true)
r_8x1_r = gannAngleLevel(swingLo, 4.0,   true)

// Support levels (from swing high, going down)
s_1x16  = gannAngleLevel(swingHi, 0.125, false)
s_1x8   = gannAngleLevel(swingHi, 0.25,  false)
s_1x6   = gannAngleLevel(swingHi, 0.333, false)
s_1x4   = gannAngleLevel(swingHi, 0.5,   false)
s_1x1   = gannAngleLevel(swingHi, 1.0,   false)   // Key 45° angle
s_4x1   = gannAngleLevel(swingHi, 2.0,   false)   // Sell entry
s_6x1   = gannAngleLevel(swingHi, 3.0,   false)
s_8x1_s = gannAngleLevel(swingHi, 4.0,   false)

// ============================================================================
// C2: SQUARE OF 9 PRICE LEVELS
// ============================================================================
// SQ9 cardinal degrees: 90°, 180°, 270°, 360°
// Formula: level = (sqrt(price) + n * degree/360)²
// Source: PDFs 4, 5

sq9Level(float price, int n, float degree) =>
    sq = math.sqrt(price)
    result = sq + n * degree / 360.0
    result * result

sq9_90_up   = sq9Level(close, 1, 90)
sq9_180_up  = sq9Level(close, 1, 180)
sq9_270_up  = sq9Level(close, 1, 270)
sq9_360_up  = sq9Level(close, 1, 360)
sq9_90_dn   = sq9Level(close, -1, 90)
sq9_180_dn  = sq9Level(close, -1, 180)
sq9_270_dn  = sq9Level(close, -1, 270)
sq9_360_dn  = sq9Level(close, -1, 360)

// Check if price is near any SQ9 cardinal level (within tolerance)
isNearSQ9(float price, float tol) =>
    near = false
    near := near or math.abs(price - sq9_90_up)  / price * 100 < tol
    near := near or math.abs(price - sq9_180_up) / price * 100 < tol
    near := near or math.abs(price - sq9_270_up) / price * 100 < tol
    near := near or math.abs(price - sq9_360_up) / price * 100 < tol
    near := near or math.abs(price - sq9_90_dn)  / price * 100 < tol
    near := near or math.abs(price - sq9_180_dn) / price * 100 < tol
    near := near or math.abs(price - sq9_270_dn) / price * 100 < tol
    near := near or math.abs(price - sq9_360_dn) / price * 100 < tol
    near

sq9Confluence = isNearSQ9(close, i_sq9Tol)

// ============================================================================
// C3: NUMBER VIBRATION ANALYSIS
// ============================================================================
// Digit reduction: sum digits until single digit
// Vibration 9 = "change number" (reversal likely)
// Source: PDF 6 "WD GANN Number Vibrations"

digitSum(int val) =>
    n = math.abs(val)
    sum = 0
    sum := n % 10
    n := math.floor(n / 10)
    sum += n % 10
    n := math.floor(n / 10)
    sum += n % 10
    n := math.floor(n / 10)
    sum += n % 10
    n := math.floor(n / 10)
    sum += n % 10
    n := math.floor(n / 10)
    sum += n % 10
    n := math.floor(n / 10)
    sum += n % 10
    n := math.floor(n / 10)
    sum += n % 10
    n := math.floor(n / 10)
    sum += n % 10
    // Reduce to single digit
    while sum >= 10
        s2 = 0
        s2 := sum % 10
        sum := math.floor(sum / 10)
        s2 += sum % 10
        sum := math.floor(sum / 10)
        s2 += sum
        sum := s2
    sum

priceVibration = digitSum(math.round(close))
isVibration9   = priceVibration == 9

// ============================================================================
// C4: DAILY VOLATILITY CALCULATION
// ============================================================================
// Log-return based volatility (matches Python implementation)
// Source: PDF 5

logReturn  = math.log(close / close[1])
dailyVol   = ta.stdev(logReturn, i_volLen) * 100   // percentage
annualVol  = dailyVol * math.sqrt(365)              // annualized for crypto (24/7)

// ============================================================================
// C5: DYNAMIC GANN LEVELS (Volatility-Adjusted)
// ============================================================================
// When annual vol > threshold → use SQ12 (12 divisions of 360° = 30° each)
// Expected high/low = price ± (dailyVol% × price)
// Source: PDF 5

useDynamic   = annualVol > i_dynVolThresh
expectedHigh = close * (1 + dailyVol / 100)
expectedLow  = close * (1 - dailyVol / 100)

// Dynamic SQ12 levels (30° intervals around current price)
dynSQ12_up1  = sq9Level(close, 1, 30)
dynSQ12_up2  = sq9Level(close, 2, 30)
dynSQ12_up3  = sq9Level(close, 3, 30)
dynSQ12_dn1  = sq9Level(close, -1, 30)
dynSQ12_dn2  = sq9Level(close, -2, 30)
dynSQ12_dn3  = sq9Level(close, -3, 30)

// ============================================================================
// C6: 144-CYCLE PRICE ZONES
// ============================================================================
// Gann's master cycle number = 144; price levels at multiples of 144
// Source: PDF 6, PDF 17 (Great Cycle = 144² = 20,736)

cycle144_base  = math.floor(close / 144) * 144
cycle144_below = cycle144_base
cycle144_above = cycle144_base + 144
cycle144_near  = math.abs(close - cycle144_below) < math.abs(close - cycle144_above) ? cycle144_below : cycle144_above
cycle144_dist  = math.abs(close - cycle144_near) / close * 100

// ============================================================================
// C7: TREND CONFIRMATION FROM GANN ANGLES
// ============================================================================
// Price > 1x1 resistance from low = UPTREND
// Price < 1x1 support from high = DOWNTREND
// Source: PDF 5

trendUp    = close > r_1x1 and not na(r_1x1)
trendDown  = close < s_1x1 and not na(s_1x1)
trendBull  = trendUp and not trendDown
trendBear  = trendDown and not trendUp

// Strong trend confirmation: above/below 4x1
strongBull = close > r_4x1 and not na(r_4x1)
strongBear = close < s_4x1 and not na(s_4x1)

// ============================================================================
// C9: HEXAGON CHART LEVELS
// ============================================================================
// The Hexagon chart places numbers in concentric 6-fold rings.
// Key angle levels at 60°, 120°, 180°, 240°, 300°, 360°
// Formula: level = (sqrt(seed) ± deg/180)²
// Source: PDF 9 "1931 SQ9 Hexagon Chart"

hexAngleLevel(float seed, float deg, bool isUp) =>
    sq = math.sqrt(seed)
    offset = deg / 180.0
    adj = isUp ? sq + offset : sq - offset
    adj > 0 ? adj * adj : na

// Calculate hexagon levels from swing low (support seed)
hex_60_up   = hexAngleLevel(swingLo, 60,  true)
hex_120_up  = hexAngleLevel(swingLo, 120, true)
hex_180_up  = hexAngleLevel(swingLo, 180, true)
hex_240_up  = hexAngleLevel(swingLo, 240, true)
hex_300_up  = hexAngleLevel(swingLo, 300, true)
hex_360_up  = hexAngleLevel(swingLo, 360, true)

hex_60_dn   = hexAngleLevel(swingHi, 60,  false)
hex_120_dn  = hexAngleLevel(swingHi, 120, false)
hex_180_dn  = hexAngleLevel(swingHi, 180, false)
hex_240_dn  = hexAngleLevel(swingHi, 240, false)
hex_300_dn  = hexAngleLevel(swingHi, 300, false)
hex_360_dn  = hexAngleLevel(swingHi, 360, false)

// Check if price near any hexagon level
isNearHex(float price, float tol) =>
    near = false
    near := near or (not na(hex_60_up)  and math.abs(price - hex_60_up)  / price * 100 < tol)
    near := near or (not na(hex_120_up) and math.abs(price - hex_120_up) / price * 100 < tol)
    near := near or (not na(hex_180_up) and math.abs(price - hex_180_up) / price * 100 < tol)
    near := near or (not na(hex_240_up) and math.abs(price - hex_240_up) / price * 100 < tol)
    near := near or (not na(hex_300_up) and math.abs(price - hex_300_up) / price * 100 < tol)
    near := near or (not na(hex_360_up) and math.abs(price - hex_360_up) / price * 100 < tol)
    near := near or (not na(hex_60_dn)  and math.abs(price - hex_60_dn)  / price * 100 < tol)
    near := near or (not na(hex_120_dn) and math.abs(price - hex_120_dn) / price * 100 < tol)
    near := near or (not na(hex_180_dn) and math.abs(price - hex_180_dn) / price * 100 < tol)
    near

hexConfluence = isNearHex(close, i_sq9Tol)

// ============================================================================
// C10: RANGE PERCENTAGE DIVISIONS (1/8th & 1/3rd)
// ============================================================================
// Gann percentages: 12.5%, 25%, 33.3%, 37.5%, 50%, 62.5%, 66.6%, 75%, 87.5%
// Applied to the current swing range to find S/R levels
// "The 50% level is the center of gravity" — Gann
// Source: PDFs 12, 17, 18

priceRange   = swingHi - swingLo

// Support levels (from high, retracing down into range)
range_125    = swingHi - priceRange * 0.125    // 12.5% — 1/8
range_250    = swingHi - priceRange * 0.250    // 25%   — 2/8
range_333    = swingHi - priceRange * 0.333    // 33.3% — 1/3
range_375    = swingHi - priceRange * 0.375    // 37.5% — 3/8
range_500    = swingHi - priceRange * 0.500    // 50%   — center of gravity
range_625    = swingHi - priceRange * 0.625    // 62.5% — 5/8
range_666    = swingHi - priceRange * 0.666    // 66.6% — 2/3
range_750    = swingHi - priceRange * 0.750    // 75%   — 6/8
range_875    = swingHi - priceRange * 0.875    // 87.5% — 7/8

// Extension levels (projecting above the high)
ext_125      = swingHi + priceRange * 0.125
ext_250      = swingHi + priceRange * 0.250
ext_500      = swingHi + priceRange * 0.500
ext_1000     = swingHi + priceRange * 1.000

// Check if price is near any range percentage level
isNearRange(float price, float tol) =>
    near = false
    near := near or math.abs(price - range_125) / price * 100 < tol
    near := near or math.abs(price - range_250) / price * 100 < tol
    near := near or math.abs(price - range_333) / price * 100 < tol
    near := near or math.abs(price - range_375) / price * 100 < tol
    near := near or math.abs(price - range_500) / price * 100 < tol
    near := near or math.abs(price - range_625) / price * 100 < tol
    near := near or math.abs(price - range_666) / price * 100 < tol
    near := near or math.abs(price - range_750) / price * 100 < tol
    near := near or math.abs(price - range_875) / price * 100 < tol
    near

rangeConfluence = isNearRange(close, 0.3)   // 0.3% tolerance for range levels

// ============================================================================
// C11: SWING CHART TREND ANALYSIS (Mechanical)
// ============================================================================
// Count higher highs / higher lows vs lower highs / lower lows
// If majority are HH + HL → uptrend; LH + LL → downtrend
// Source: PDF 18 "Charles Shephard Gann Cycles Course"

swingTrendLen = i_swingTrendLen

// Count higher highs and higher lows over last N bars
hhCount = 0
hlCount = 0
lhCount = 0
llCount = 0
for i = 1 to swingTrendLen
    if high[i-1] > high[i]
        hhCount += 1
    if high[i-1] < high[i]
        lhCount += 1
    if low[i-1] > low[i]
        hlCount += 1
    if low[i-1] < low[i]
        llCount += 1

swingBullish = hhCount > swingTrendLen / 2 and hlCount > swingTrendLen / 2
swingBearish = lhCount > swingTrendLen / 2 and llCount > swingTrendLen / 2

// ============================================================================
// C12: MASTER 144 SQUARE / GREAT CYCLE (20,736)
// ============================================================================
// Great Cycle = 144² = 20,736 (days, degrees, or price units)
// Master Numbers: 3, 5, 7, 9, 12
// Key resistance fractions: 1/3, 1/2, 2/3, 3/4 of Great Cycle
// Source: PDF 17 "1953 Mathematical Formula"

greatCycle      = 20736.0
gc_third        = greatCycle / 3.0     // 6912
gc_half         = greatCycle / 2.0     // 10368
gc_twoThird     = greatCycle * 2 / 3   // 13824
gc_threeFourth  = greatCycle * 3 / 4   // 15552

// Count bars from first bar (proxy for days elapsed)
var int totalBarsElapsed = 0
totalBarsElapsed += 1

// Check if total elapsed bars aligns with Great Cycle fractions (within 2%)
isNearGC(int bars) =>
    near = false
    near := near or (gc_third  > 0 and math.abs(bars - gc_third)  / gc_third  * 100 < 2)
    near := near or (gc_half   > 0 and math.abs(bars - gc_half)   / gc_half   * 100 < 2)
    near := near or (gc_twoThird > 0 and math.abs(bars - gc_twoThird) / gc_twoThird * 100 < 2)
    near

gcAlignment = isNearGC(totalBarsElapsed)

// ============================================================================
// C13: SEASONAL CARDINAL TIMING
// ============================================================================
// Year begins March 21 (spring equinox); cardinal points:
//   March 21, June 21, September 21, December 21
// Octave points (from Square of 52):
//   Feb 5, May 6, Aug 5, Nov 5
// Source: PDFs 11, 12, 19

currentMonth = month
currentDay   = dayofmonth

// Check if today is within ±3 days of a cardinal date
isNearCardinal(int m, int d) =>
    isNear = false
    // March 21 (spring equinox)
    isNear := isNear or (m == 3 and d >= 18 and d <= 24)
    // June 21 (summer solstice)
    isNear := isNear or (m == 6 and d >= 18 and d <= 24)
    // September 21 (autumn equinox)
    isNear := isNear or (m == 9 and d >= 18 and d <= 24)
    // December 21 (winter solstice)
    isNear := isNear or (m == 12 and d >= 18 and d <= 24)
    isNear

isNearOctave(int m, int d) =>
    isNear = false
    // Feb 5
    isNear := isNear or (m == 2 and d >= 2 and d <= 8)
    // May 6
    isNear := isNear or (m == 5 and d >= 3 and d <= 9)
    // Aug 5
    isNear := isNear or (m == 8 and d >= 2 and d <= 8)
    // Nov 5
    isNear := isNear or (m == 11 and d >= 2 and d <= 8)
    isNear

isCardinalDate = isNearCardinal(currentMonth, currentDay)
isOctaveDate   = isNearOctave(currentMonth, currentDay)
isSeasonalDate = isCardinalDate or isOctaveDate

// ============================================================================
// C14: FATAL NUMBER ANALYSIS (Gann's Fatal 49)
// ============================================================================
// "49 was often quoted by WD Gann as the Fatal Number" (PDF 18, p.86)
// Fatal multiples: 49, 98, 147, 196, 245, 294, 343, 392, 441, 490
// Check if price is near a multiple of 49
// Source: PDF 18 pp.86, 100; PDF 12 p.6

fatalNumber = 49.0

isNearFatal(float price) =>
    if price <= 0
        false
    else
        // Find nearest multiple of 49
        nearestMult = math.round(price / fatalNumber) * fatalNumber
        deviation = math.abs(price - nearestMult) / price * 100
        deviation < 3.0    // within 3%

fatalConfluence = i_useFatal ? isNearFatal(close) : false

// Also check bars since last swing pivot against fatal multiples
var int barsSinceSwingLo = 0
var int barsSinceSwingHi = 0
if low == swingLo
    barsSinceSwingLo := 0
else
    barsSinceSwingLo += 1
if high == swingHi
    barsSinceSwingHi := 0
else
    barsSinceSwingHi += 1

isTimeFatal(int bars) =>
    if bars <= 0
        false
    else
        bars % 49 == 0 or bars % 98 == 0 or bars % 147 == 0 or bars % 196 == 0

timeFatalLo = isTimeFatal(barsSinceSwingLo)
timeFatalHi = isTimeFatal(barsSinceSwingHi)

// ============================================================================
// C15: SHEPHARD KEY CYCLES
// ============================================================================
// Key cycle numbers from Shephard: 631, 668, 840, 1260, 1262, 1290, 1336
// Also: Mars=687, Venus=224, Week=168, Wheel=2520
// When bars from a pivot match these, reversal is likely
// Source: PDF 18 pp.85-86, 130, 148

isShephardCycle(int bars) =>
    if bars <= 0
        false
    else
        tol = bars * 0.02  // 2% tolerance
        near = false
        near := near or math.abs(bars - 168)  <= tol
        near := near or math.abs(bars - 224)  <= tol
        near := near or math.abs(bars - 343)  <= tol
        near := near or math.abs(bars - 490)  <= tol
        near := near or math.abs(bars - 631)  <= tol
        near := near or math.abs(bars - 668)  <= tol
        near := near or math.abs(bars - 687)  <= tol
        near := near or math.abs(bars - 840)  <= tol
        near := near or math.abs(bars - 1260) <= tol
        near := near or math.abs(bars - 1262) <= tol
        near := near or math.abs(bars - 1290) <= tol
        near := near or math.abs(bars - 1336) <= tol
        near

shepherdCycleLo = isShephardCycle(barsSinceSwingLo)
shepherdCycleHi = isShephardCycle(barsSinceSwingHi)
shepherdAlert   = shepherdCycleLo or shepherdCycleHi

// ============================================================================
// C16: PLANETARY CYCLE WINDOWS
// ============================================================================
// Mars orbit = 687 days; Venus synodic = 224 days; Week = 168 hours
// Check if bars from pivot align with planetary cycles or their Gann divisions
// Source: PDF 18 pp.67, 71, 75, 108

isPlanetaryCycle(int bars) =>
    if bars <= 0
        false
    else
        tol = bars * 0.02
        near = false
        // Mars cycle divisions
        near := near or math.abs(bars - 687)  <= tol      // Full Mars
        near := near or math.abs(bars - 344)  <= tol      // 50% Mars
        near := near or math.abs(bars - 229)  <= tol      // 33% Mars
        near := near or math.abs(bars - 172)  <= tol      // 25% Mars
        // Venus cycle divisions
        near := near or math.abs(bars - 224)  <= tol      // Full Venus
        near := near or math.abs(bars - 112)  <= tol      // 50% Venus
        near := near or math.abs(bars - 75)   <= tol      // 33% Venus
        // Week hour applied as days
        near := near or math.abs(bars - 168)  <= tol      // 168 (hours in week)
        near := near or math.abs(bars - 336)  <= tol      // 2 × 168
        near := near or math.abs(bars - 504)  <= tol      // 3 × 168
        near

planetaryCycleLo = isPlanetaryCycle(barsSinceSwingLo)
planetaryCycleHi = isPlanetaryCycle(barsSinceSwingHi)

// ============================================================================
// C17: CUMULATIVE RANGE ANALYSIS
// ============================================================================
// Sum consecutive daily ranges; when cumulative sum matches a key cycle
// number, hidden reversal signal emerges
// Source: PDF 18 pp.96, 110, 135

dailyRange    = high - low
cumRange3     = dailyRange + dailyRange[1] + dailyRange[2]
cumRange5     = cumRange3 + dailyRange[3] + dailyRange[4]

// Check if cumulative range is near a significant number
isSignificantCumRange(float cumR) =>
    if cumR <= 0
        false
    else
        near = false
        near := near or math.abs(cumR - 144) / 144 * 100 < 5
        near := near or math.abs(cumR - 168) / 168 * 100 < 5
        near := near or math.abs(cumR - 224) / 224 * 100 < 5
        near := near or math.abs(cumR - 360) / 360 * 100 < 5
        near := near or math.abs(cumR - 687) / 687 * 100 < 5
        near

cumRangeSignal = isSignificantCumRange(cumRange3) or isSignificantCumRange(cumRange5)

// ============================================================================
// C18: MASTER TIME FACTOR (7/10/20/30/60-year cycles)
// ============================================================================
// Check if current year aligns with major cycle years from key historical dates
// BTC genesis: 2009; Gold 1980; Major crash: 1929
// Source: PDF 13 (Flanagan), PDF 16 (Jenkins)

currentYear = year

isMasterTimeYear(int yr) =>
    near = false
    // 7-year cycles from 2009 (BTC genesis)
    near := near or (yr - 2009) % 7 == 0
    // 10-year decennial
    near := near or yr % 10 == 9 or yr % 10 == 0
    // 20-year Jupiter-Saturn
    near := near or (yr - 2000) % 20 == 0
    // 30-year (360 months)
    near := near or (yr - 1929) % 30 == 0
    // 60-year master (all planets return)
    near := near or (yr - 1929) % 60 == 0
    near

masterTimeYear = isMasterTimeYear(currentYear)

// ============================================================================
// C19: RANGE EXTENSION LEVELS
// ============================================================================
// Extension projections above the high (for targets)
// Source: PDFs 12, 17, 18

// Already computed above as ext_125, ext_250, ext_500, ext_1000

// ============================================================================
// C20: MULTI-TIMEFRAME CONFLUENCE
// ============================================================================
// Weekly and monthly trend context for daily signals
// Source: General Gann principle — weekly overrides daily

weeklyHigh = request.security(syminfo.tickerid, "W", high)
weeklyLow  = request.security(syminfo.tickerid, "W", low)
weeklyClose = request.security(syminfo.tickerid, "W", close)
weeklyTrendUp   = weeklyClose > (weeklyHigh + weeklyLow) / 2
weeklyTrendDown = weeklyClose < (weeklyHigh + weeklyLow) / 2

// ============================================================================
// C21: CONFIDENCE SCORING & SIGNAL GENERATION
// ============================================================================
// Scoring system (matches Python generate_signal):
//   +0.30  Gann angle trend confirmed
//   +0.10  SQ9 confluence (within 0.5%)
//   +0.10  Vibration = 9 (change number)
//   +0.15  Dynamic vol confirms direction
//   +0.05  Range % level nearby
//   +0.05  Hexagon level nearby
//   +0.05  Fatal Number nearby
//   +0.05  Swing trend confirms
//   +0.05  Seasonal cardinal date
//   +0.05  Shephard/planetary cycle window
//   +0.15  R:R ratio ≥ 2.5:1
//   -0.10  R:R ratio < 1.5:1
//   Max: 1.0; Min to trade: configurable (default 0.40)

// Calculate entry/stop/target
buyEntry  = not na(r_1x4) ? r_1x4 : close
buyStop   = not na(r_1x1) ? math.min(r_1x1, close * 0.95) : close * 0.95
sellEntry = not na(s_4x1) ? s_4x1 : close
sellStop  = not na(s_1x1) ? math.max(s_1x1, close * 1.05) : close * 1.05

buyTarget  = sq9_180_up
sellTarget = sq9_180_dn

// Risk-reward calculation
buyRisk    = math.abs(buyEntry - buyStop)
buyReward  = math.abs(buyTarget - buyEntry)
buyRR      = buyRisk > 0 ? buyReward / buyRisk : 0

sellRisk   = math.abs(sellEntry - sellStop)
sellReward = math.abs(sellEntry - sellTarget)
sellRR     = sellRisk > 0 ? sellReward / sellRisk : 0

// --- Buy Confidence (21-component scoring) ---
buyConf = 0.0
// C7: Gann angle trend
buyConf := buyConf + (trendBull ? 0.30 : 0.0)
// C2: SQ9 confluence
buyConf := buyConf + (sq9Confluence ? 0.10 : 0.0)
// C3: Vibration 9
buyConf := buyConf + (isVibration9 ? 0.10 : 0.0)
// C5: Dynamic volatility confirms
buyConf := buyConf + (useDynamic and close < expectedHigh ? 0.15 : 0.0)
// C10: Range percentage level nearby
buyConf := buyConf + (i_useRangePct and rangeConfluence ? 0.05 : 0.0)
// C9: Hexagon level nearby
buyConf := buyConf + (i_useHexConf and hexConfluence ? 0.05 : 0.0)
// C14: Fatal Number nearby
buyConf := buyConf + (i_useFatal and fatalConfluence ? 0.05 : 0.0)
// C11: Swing trend confirms bullish
buyConf := buyConf + (i_useSwing and swingBullish ? 0.05 : 0.0)
// C13: Seasonal cardinal date
buyConf := buyConf + (i_useSeasonal and isSeasonalDate ? 0.05 : 0.0)
// C15/C16: Shephard/planetary cycle window near swing low
buyConf := buyConf + (shepherdCycleLo or planetaryCycleLo ? 0.05 : 0.0)
// C20: Weekly trend confirms daily
buyConf := buyConf + (weeklyTrendUp ? 0.05 : 0.0)
// Risk-reward validation
buyConf := buyConf + (buyRR >= i_rrRatio ? 0.15 : buyRR >= 1.5 ? 0.05 : -0.10)
// Clamp 0.0 - 1.0
buyConf := math.max(0.0, math.min(1.0, buyConf))

// --- Sell Confidence (21-component scoring) ---
sellConf = 0.0
// C7: Gann angle trend
sellConf := sellConf + (trendBear ? 0.30 : 0.0)
// C2: SQ9 confluence
sellConf := sellConf + (sq9Confluence ? 0.10 : 0.0)
// C3: Vibration 9
sellConf := sellConf + (isVibration9 ? 0.10 : 0.0)
// C5: Dynamic volatility confirms
sellConf := sellConf + (useDynamic and close > expectedLow ? 0.15 : 0.0)
// C10: Range percentage level nearby
sellConf := sellConf + (i_useRangePct and rangeConfluence ? 0.05 : 0.0)
// C9: Hexagon level nearby
sellConf := sellConf + (i_useHexConf and hexConfluence ? 0.05 : 0.0)
// C14: Fatal Number nearby
sellConf := sellConf + (i_useFatal and fatalConfluence ? 0.05 : 0.0)
// C11: Swing trend confirms bearish
sellConf := sellConf + (i_useSwing and swingBearish ? 0.05 : 0.0)
// C13: Seasonal cardinal date
sellConf := sellConf + (i_useSeasonal and isSeasonalDate ? 0.05 : 0.0)
// C15/C16: Shephard/planetary cycle window near swing high
sellConf := sellConf + (shepherdCycleHi or planetaryCycleHi ? 0.05 : 0.0)
// C20: Weekly trend confirms daily
sellConf := sellConf + (weeklyTrendDown ? 0.05 : 0.0)
// Risk-reward validation
sellConf := sellConf + (sellRR >= i_rrRatio ? 0.15 : sellRR >= 1.5 ? 0.05 : -0.10)
// Clamp 0.0 - 1.0
sellConf := math.max(0.0, math.min(1.0, sellConf))

// ============================================================================
// STRATEGY — ENTRIES, EXITS, AND TRADE MANAGEMENT
// ============================================================================

// Entry conditions
longCond  = buyConf >= i_confMin and trendBull and buyRR >= 1.5
shortCond = sellConf >= i_confMin and trendBear and sellRR >= 1.5

// Conflict resolution: only take the stronger signal
goLong  = longCond  and (not shortCond or buyConf > sellConf)
goShort = shortCond and (not longCond  or sellConf > buyConf)

// Position sizing based on risk
riskAmt   = strategy.equity * i_riskPct / 100
longQty   = buyRisk  > 0 ? riskAmt / buyRisk  : 0
shortQty  = sellRisk > 0 ? riskAmt / sellRisk : 0

// Track bars in trade
var int barsInTrade = 0
if strategy.position_size != 0
    barsInTrade += 1
else
    barsInTrade := 0

// Entry execution with trailing stop
longTrailActivate  = math.abs(buyTarget - buyEntry)   * 0.5
longTrailDist      = close * i_trailPct / 100
shortTrailActivate = math.abs(sellEntry - sellTarget)  * 0.5
shortTrailDist     = close * i_trailPct / 100

if goLong and strategy.position_size <= 0
    strategy.entry("Long", strategy.long, qty=longQty)
    strategy.exit("Long SL/TP", "Long", stop=buyStop, limit=buyTarget,
         trail_offset=longTrailActivate, trail_points=longTrailDist)
    barsInTrade := 0

if goShort and strategy.position_size >= 0
    strategy.entry("Short", strategy.short, qty=shortQty)
    strategy.exit("Short SL/TP", "Short", stop=sellStop, limit=sellTarget,
         trail_offset=shortTrailActivate, trail_points=shortTrailDist)
    barsInTrade := 0

// Time-based exit (max bars in trade — Rule of 72 from PDF 4)
if barsInTrade >= i_maxBars and strategy.position_size != 0
    strategy.close_all("Timeout")
    barsInTrade := 0

// ============================================================================
// VISUAL OVERLAYS
// ============================================================================

// --- Gann Angle Levels ---
plot(i_showAngles ? r_1x1 : na, "1x1 Resistance (45°)", color=color.new(color.green, 50), linewidth=2)
plot(i_showAngles ? r_1x4 : na, "1x4 Resistance (Buy Entry)", color=color.new(color.lime, 60))
plot(i_showAngles ? r_4x1 : na, "4x1 Resistance", color=color.new(color.green, 70))
plot(i_showAngles ? s_1x1 : na, "1x1 Support (45°)", color=color.new(color.red, 50), linewidth=2)
plot(i_showAngles ? s_4x1 : na, "4x1 Support (Sell Entry)", color=color.new(color.orange, 60))

// --- SQ9 Levels ---
plot(i_showSQ9 ? sq9_180_up : na, "SQ9 180° Up", color=color.new(color.blue, 60), style=plot.style_cross)
plot(i_showSQ9 ? sq9_360_up : na, "SQ9 360° Up", color=color.new(color.blue, 40), style=plot.style_cross)
plot(i_showSQ9 ? sq9_180_dn : na, "SQ9 180° Down", color=color.new(color.purple, 60), style=plot.style_cross)
plot(i_showSQ9 ? sq9_360_dn : na, "SQ9 360° Down", color=color.new(color.purple, 40), style=plot.style_cross)

// --- 144 Cycle Levels ---
plot(i_show144 ? cycle144_below : na, "144 Below", color=color.new(color.yellow, 50), style=plot.style_stepline)
plot(i_show144 ? cycle144_above : na, "144 Above", color=color.new(color.yellow, 50), style=plot.style_stepline)

// --- Range Percentage Levels ---
plot(i_showRange ? range_500 : na, "Range 50% (Center of Gravity)", color=color.new(color.white, 40), linewidth=2, style=plot.style_stepline)
plot(i_showRange ? range_250 : na, "Range 25%", color=color.new(color.gray, 60), style=plot.style_stepline)
plot(i_showRange ? range_333 : na, "Range 33.3%", color=color.new(color.gray, 70), style=plot.style_stepline)
plot(i_showRange ? range_666 : na, "Range 66.6%", color=color.new(color.gray, 70), style=plot.style_stepline)
plot(i_showRange ? range_750 : na, "Range 75%", color=color.new(color.gray, 60), style=plot.style_stepline)

// --- Hexagon Levels ---
plot(i_showHex ? hex_180_up : na, "Hex 180° Up", color=color.new(color.aqua, 60), style=plot.style_cross)
plot(i_showHex ? hex_360_up : na, "Hex 360° Up", color=color.new(color.aqua, 40), style=plot.style_cross)
plot(i_showHex ? hex_180_dn : na, "Hex 180° Down", color=color.new(color.fuchsia, 60), style=plot.style_cross)

// --- Dynamic Expected Range ---
p_expHi = plot(useDynamic ? expectedHigh : na, "Expected High", color=color.new(color.teal, 80))
p_expLo = plot(useDynamic ? expectedLow  : na, "Expected Low",  color=color.new(color.teal, 80))
fill(p_expHi, p_expLo, color=color.new(color.teal, 95), title="Volatility Range")

// --- Signal Markers ---
plotshape(goLong  and strategy.position_size <= 0, "BUY Signal",
     style=shape.triangleup, location=location.belowbar,
     color=color.green, size=size.normal, text="BUY")
plotshape(goShort and strategy.position_size >= 0, "SELL Signal",
     style=shape.triangledown, location=location.abovebar,
     color=color.red, size=size.normal, text="SELL")

// --- Shephard/Fatal cycle markers ---
plotshape(shepherdAlert, "Shephard Cycle", style=shape.diamond,
     location=location.abovebar, color=color.new(color.yellow, 30),
     size=size.tiny, text="SC")
plotshape(timeFatalLo or timeFatalHi, "Fatal Time", style=shape.xcross,
     location=location.belowbar, color=color.new(color.orange, 30),
     size=size.tiny, text="F49")

// --- Seasonal markers ---
bgcolor(isCardinalDate ? color.new(color.blue, 92) : na, title="Cardinal Date")
bgcolor(isOctaveDate   ? color.new(color.purple, 92) : na, title="Octave Date")

// --- Trend background ---
bgcolor(trendBull ? color.new(color.green, 95) : trendBear ? color.new(color.red, 95) : na,
     title="Trend Background")

// ============================================================================
// INFO TABLE — Full 21-Component Dashboard
// ============================================================================
var table infoTable = table.new(position.top_right, 2, 16,
     bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Header
    table.cell(infoTable, 0, 0, "Gann Complete (21 Components)", text_color=color.white, text_size=size.normal)
    table.cell(infoTable, 1, 0, "", text_color=color.white)
    
    // Row 1: Trend
    table.cell(infoTable, 0, 1, "Trend (C7)", text_color=color.gray, text_size=size.small)
    trendStr = trendBull ? "▲ BULLISH" : trendBear ? "▼ BEARISH" : "— NEUTRAL"
    trendClr = trendBull ? color.green : trendBear ? color.red : color.gray
    table.cell(infoTable, 1, 1, trendStr, text_color=trendClr, text_size=size.small)
    
    // Row 2: Swing Trend (C11)
    table.cell(infoTable, 0, 2, "Swing (C11)", text_color=color.gray, text_size=size.small)
    swingStr = swingBullish ? "▲ HH+HL" : swingBearish ? "▼ LH+LL" : "— Mixed"
    swingClr = swingBullish ? color.green : swingBearish ? color.red : color.gray
    table.cell(infoTable, 1, 2, swingStr, text_color=swingClr, text_size=size.small)
    
    // Row 3: Buy Confidence
    table.cell(infoTable, 0, 3, "Buy Conf", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(buyConf, "#.##"), text_color=buyConf >= i_confMin ? color.green : color.gray, text_size=size.small)
    
    // Row 4: Sell Confidence
    table.cell(infoTable, 0, 4, "Sell Conf", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(sellConf, "#.##"), text_color=sellConf >= i_confMin ? color.red : color.gray, text_size=size.small)
    
    // Row 5: Vibration (C3)
    table.cell(infoTable, 0, 5, "Vibration (C3)", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 5, str.tostring(priceVibration) + (isVibration9 ? " ⚡CHANGE" : ""), text_color=isVibration9 ? color.yellow : color.white, text_size=size.small)
    
    // Row 6: SQ9 (C2)
    table.cell(infoTable, 0, 6, "SQ9 (C2)", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 6, sq9Confluence ? "✓ Near" : "✗ No", text_color=sq9Confluence ? color.blue : color.gray, text_size=size.small)
    
    // Row 7: Hexagon (C9)
    table.cell(infoTable, 0, 7, "Hexagon (C9)", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 7, hexConfluence ? "✓ Near" : "✗ No", text_color=hexConfluence ? color.aqua : color.gray, text_size=size.small)
    
    // Row 8: Range % (C10)
    table.cell(infoTable, 0, 8, "Range% (C10)", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 8, rangeConfluence ? "✓ Near" : "✗ No", text_color=rangeConfluence ? color.white : color.gray, text_size=size.small)
    
    // Row 9: Fatal 49 (C14)
    table.cell(infoTable, 0, 9, "Fatal 49 (C14)", text_color=color.gray, text_size=size.small)
    fatalStr = fatalConfluence ? "✓ Price" : timeFatalLo or timeFatalHi ? "✓ Time" : "✗ No"
    fatalClr = fatalConfluence or timeFatalLo or timeFatalHi ? color.orange : color.gray
    table.cell(infoTable, 1, 9, fatalStr, text_color=fatalClr, text_size=size.small)
    
    // Row 10: Seasonal (C13)
    table.cell(infoTable, 0, 10, "Seasonal (C13)", text_color=color.gray, text_size=size.small)
    seasStr = isCardinalDate ? "◆ Cardinal" : isOctaveDate ? "◆ Octave" : "—"
    seasClr = isSeasonalDate ? color.blue : color.gray
    table.cell(infoTable, 1, 10, seasStr, text_color=seasClr, text_size=size.small)
    
    // Row 11: Shephard (C15)
    table.cell(infoTable, 0, 11, "Shephard (C15)", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 11, shepherdAlert ? "⚠ Cycle!" : "—", text_color=shepherdAlert ? color.yellow : color.gray, text_size=size.small)
    
    // Row 12: Volatility
    table.cell(infoTable, 0, 12, "Daily Vol", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 12, str.tostring(dailyVol, "#.##") + "%", text_color=color.white, text_size=size.small)
    
    // Row 13: Annual Vol
    table.cell(infoTable, 0, 13, "Ann. Vol", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 13, str.tostring(annualVol, "#.#") + "%" + (useDynamic ? " [SQ12]" : ""), text_color=useDynamic ? color.teal : color.white, text_size=size.small)
    
    // Row 14: Buy R:R
    table.cell(infoTable, 0, 14, "Buy R:R", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 14, str.tostring(buyRR, "#.#") + ":1", text_color=buyRR >= i_rrRatio ? color.green : color.gray, text_size=size.small)
    
    // Row 15: Sell R:R
    table.cell(infoTable, 0, 15, "Sell R:R", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 15, str.tostring(sellRR, "#.#") + ":1", text_color=sellRR >= i_rrRatio ? color.red : color.gray, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(goLong  and strategy.position_size <= 0,
     "Gann BUY Signal",
     "Gann Complete: BUY signal — Conf: {{plot_2}}")
alertcondition(goShort and strategy.position_size >= 0,
     "Gann SELL Signal",
     "Gann Complete: SELL signal — Conf: {{plot_3}}")
alertcondition(isVibration9,
     "Vibration 9 Alert",
     "Price vibration = 9 (CHANGE NUMBER) — Watch for reversal")
alertcondition(shepherdAlert,
     "Shephard Cycle Alert",
     "Shephard key cycle alignment detected — Major reversal window")
alertcondition(fatalConfluence,
     "Fatal 49 Alert",
     "Price near Fatal Number (49) multiple — Gann's fatal zone")
alertcondition(isSeasonalDate,
     "Seasonal Cardinal Alert",
     "Seasonal cardinal/octave date — Increased reversal probability")
alertcondition(cumRangeSignal,
     "Cumulative Range Alert",
     "Cumulative range matches key cycle number — Hidden reversal signal")
